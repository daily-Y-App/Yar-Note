<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Work Calendar & 15-Days Slip</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f4f7f6; color: #333; padding-bottom: 30px; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #1a2a6c, #b21f1f); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        /* Calendar UI */
        .calendar-container { padding: 10px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-name { text-align: center; font-weight: bold; font-size: 12px; color: #777; padding: 5px 0; }
        .day { background: white; aspect-ratio: 1/1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; position: relative; border: 1px solid #eee; transition: 0.2s; }
        .day.has-inc { background: #e8f5e9; }
        .day.has-exp { border-bottom: 3px solid #ffcdd2; }
        .dot-inc { width: 5px; height: 5px; background: #4CAF50; border-radius: 50%; margin-top: 2px; }
        .dot-exp { width: 5px; height: 5px; background: #f44336; border-radius: 50%; margin-top: 2px; }

        /* Slip Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; padding: 15px; overflow-y: auto; }
        .slip-card { background: white; width: 100%; max-width: 360px; border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .slip-title { text-align: center; border-bottom: 2px dashed #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .slip-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; align-items: center; }
        .total-row { border-top: 2px solid #333; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 18px; color: #b21f1f; }
        
        /* 15 Days Selection UI */
        .range-selector { background: white; margin: 10px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .btn { padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; }
        .btn-main { background: #1a2a6c; width: 100%; margin-top: 10px; }
        .btn-share { background: #25D366; flex: 1; }
        .btn-close { background: #666; flex: 1; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; width: 100%; max-width: 360px; }
    </style>
</head>
<body>

    <div class="header">
        <h2 id="userName">User Name</h2>
        <p id="userCode" style="font-size: 12px; opacity: 0.8;">CODE: EMP001</p>
    </div>

    <div class="range-selector">
        <p style="font-size: 13px; font-weight: bold; color: #555;">ğŸ“… áá… á€›á€€á€ºá€…á€¬ á€…á€œá€…á€ºá€‘á€¯á€á€ºá€›á€”á€º</p>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <input type="date" id="startDate" style="flex:1; padding: 8px; border-radius: 5px; border:1px solid #ddd;">
            <span style="align-self: center;">á€™á€¾</span>
            <input type="date" id="endDate" style="flex:1; padding: 8px; border-radius: 5px; border:1px solid #ddd;">
        </div>
        <button class="btn btn-main" onclick="generateRangeSlip()">ğŸ§¾ áá… á€›á€€á€ºá€…á€¬ á€…á€œá€…á€ºá€‘á€¯á€á€ºá€™á€Šá€º</button>
    </div>

    <div class="calendar-container">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)" style="border:none; background:none; font-size:20px;">â®</button>
            <h3 id="monthDisplay">Month Year</h3>
            <button onclick="changeMonth(1)" style="border:none; background:none; font-size:20px;">â¯</button>
        </div>
        <div class="grid" id="calendarGrid"></div>
    </div>

    <div id="slipModal" class="modal">
        <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
            <div id="capture-area" class="slip-card">
                <div class="slip-title">
                    <h2 id="slipTypeTitle">PAYMENT SLIP</h2>
                    <p id="slipDateRange" style="font-size: 12px; color: #666; margin-top: 5px;"></p>
                </div>
                
                <div id="slipContent"></div>

                <div class="slip-row total-row">
                    <span>á€¡á€á€¬á€¸á€á€„á€ºá€›á€„á€½á€±</span>
                    <span id="slipTotal">0à¸¿</span>
                </div>
                
                <div id="rateFooter" style="text-align: center; font-size: 11px; margin-top: 15px; color: #777; border-top: 1px solid #eee; padding-top: 10px;">
                    Daily Wage: <span id="ftWage">0</span>à¸¿ | OT: <span id="ftOt">0</span>à¸¿
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-share" onclick="shareSlip()">ğŸ“² Share</button>
                <button class="btn btn-close" onclick="closeModal()">á€•á€­á€á€ºá€™á€Šá€º</button>
            </div>
        </div>
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('f_recs')) || [];
        let profile = JSON.parse(localStorage.getItem('f_prof')) || { name: 'User', code: 'EMP001', wage: 375, ot: 69 };
        let currentDate = new Date();

        function init() {
            document.getElementById('userName').innerText = profile.name;
            document.getElementById('userCode').innerText = "CODE: " + profile.code;
            document.getElementById('ftWage').innerText = profile.wage;
            document.getElementById('ftOt').innerText = profile.ot;
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('monthDisplay');
            grid.innerHTML = "";
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthDisplay.innerText = new Intl.DateTimeFormat('my-MM', { month: 'long', year: 'numeric' }).format(currentDate);

            ['á€”á€±', 'á€œá€¬', 'á€„á€ºá€¹á€‚á€«', 'á€—á€¯á€’á€¹á€“', 'á€€á€¼á€¬', 'á€á€±á€¬', 'á€…á€”á€±'].forEach(d => grid.innerHTML += `<div class="day-name">${d}</div>`);

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayIncs = records.filter(r => r.date === dateStr && r.type === 'income');
                const dayExps = records.filter(r => r.date === dateStr && r.type === 'expense');

                const dayEl = document.createElement('div');
                dayEl.className = `day ${dayIncs.length ? 'has-inc' : ''} ${dayExps.length ? 'has-exp' : ''}`;
                
                let dots = '';
                if(dayIncs.length) dots += '<div class="dot-inc"></div>';
                if(dayExps.length) dots += '<div class="dot-exp"></div>';
                
                dayEl.innerHTML = `<span>${i}</span>${dots}`;
                dayEl.onclick = () => showDailySlip(dateStr);
                grid.appendChild(dayEl);
            }
        }

        // á€á€…á€ºá€›á€€á€ºá€…á€¬ á€…á€œá€…á€ºá€•á€¼á€›á€”á€º
        function showDailySlip(date) {
            const incs = records.filter(r => r.date === date && r.type === 'income');
            const exps = records.filter(r => r.date === date && r.type === 'expense');
            if (!incs.length && !exps.length) return;

            document.getElementById('slipTypeTitle').innerText = "DAILY SLIP";
            document.getElementById('slipDateRange').innerText = "á€›á€€á€ºá€…á€½á€²: " + date;
            
            let html = '<div style="margin-bottom:10px;"><b>ğŸ’° á€á€„á€ºá€„á€½á€±</b></div>';
            let totalInc = 0;
            incs.forEach(r => {
                const d = r.details || { h: 8, o: 0, b: 0, e: 0 };
                totalInc += r.amt;
                html += `<div class="slip-row"><span>á€¡á€œá€¯á€•á€ºá€á€»á€­á€”á€º (${d.h} á€”á€¬á€›á€®)</span> <span>${Math.round((d.h/8)*profile.wage)}à¸¿</span></div>`;
                if(d.o > 0) html += `<div class="slip-row"><span>OT (${d.o} á€”á€¬á€›á€®)</span> <span>${Math.round(d.o*profile.ot)}à¸¿</span></div>`;
                if(d.b > 0) html += `<div class="slip-row"><span>á€›á€€á€ºá€™á€¾á€”á€ºá€€á€¼á€±á€¸</span> <span>${d.b}à¸¿</span></div>`;
                if(d.e > 0) html += `<div class="slip-row"><span>á€¡á€•á€­á€¯á€á€„á€ºá€„á€½á€±</span> <span>${d.e}à¸¿</span></div>`;
            });

            html += '<div style="margin: 10px 0; border-top:1px solid #eee; padding-top:10px;"><b>ğŸ’¸ á€‘á€½á€€á€ºá€„á€½á€±</b></div>';
            let totalExp = 0;
            exps.forEach(r => {
                totalExp += r.amt;
                html += `<div class="slip-row"><span>${r.category}</span> <span style="color:red;">-${Math.round(r.amt)}à¸¿</span></div>`;
            });

            document.getElementById('slipContent').innerHTML = html;
            document.getElementById('slipTotal').innerText = Math.round(totalInc - totalExp) + "à¸¿";
            document.getElementById('slipModal').style.display = 'flex';
        }

        // áá… á€›á€€á€ºá€…á€¬ á€…á€œá€…á€ºá€‘á€¯á€á€ºá€›á€”á€º
        function generateRangeSlip() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if(!start || !end) return alert("á€›á€€á€ºá€…á€½á€² á€…/á€†á€¯á€¶á€¸ á€›á€½á€±á€¸á€•á€±á€¸á€•á€«");

            const rangeRecs = records.filter(r => r.date >= start && r.date <= end);
            if(!rangeRecs.length) return alert("á€›á€½á€±á€¸á€á€»á€šá€ºá€‘á€¬á€¸á€á€±á€¬ á€›á€€á€ºá€…á€½á€²á€¡á€á€½á€„á€ºá€¸ á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€›á€¾á€­á€•á€«");

            document.getElementById('slipTypeTitle').innerText = "15-DAYS PAY SLIP";
            document.getElementById('slipDateRange').innerText = `${start} á€™á€¾ ${end}`;

            let tWork = 0, tOt = 0, tBonus = 0, tExtra = 0, tExp = 0, workDays = 0;
            rangeRecs.forEach(r => {
                if(r.type === 'income') {
                    const d = r.details || { h: 8, o: 0, b: 0, e: 0 };
                    tWork += (d.h/8)*profile.wage;
                    tOt += d.o * profile.ot;
                    tBonus += d.b;
                    tExtra += d.e;
                    workDays++;
                } else {
                    tExp += r.amt;
                }
            });

            let html = `
                <div class="slip-row"><span>á€¡á€œá€¯á€•á€ºá€†á€„á€ºá€¸á€›á€€á€º</span> <span>${workDays} á€›á€€á€º</span></div>
                <div class="slip-row"><span>á€¡á€á€¼á€±á€á€¶á€œá€¯á€•á€ºá€¡á€¬á€¸á€á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸</span> <span>${Math.round(tWork)}à¸¿</span></div>
                <div class="slip-row"><span>OT á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸</span> <span>${Math.round(tOt)}à¸¿</span></div>
                <div class="slip-row"><span>á€›á€€á€ºá€™á€¾á€”á€ºá€€á€¼á€±á€¸/á€¡á€•á€­á€¯á€á€„á€ºá€„á€½á€±</span> <span>${Math.round(tBonus + tExtra)}à¸¿</span></div>
                <div class="slip-row" style="color:red;"><span>á€‘á€½á€€á€ºá€„á€½á€±á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸</span> <span>-${Math.round(tExp)}à¸¿</span></div>
            `;

            document.getElementById('slipContent').innerHTML = html;
            document.getElementById('slipTotal').innerText = Math.round((tWork + tOt + tBonus + tExtra) - tExp) + "à¸¿";
            document.getElementById('slipModal').style.display = 'flex';
        }

        function changeMonth(step) { currentDate.setMonth(currentDate.getMonth() + step); renderCalendar(); }
        function closeModal() { document.getElementById('slipModal').style.display = 'none'; }

        async function shareSlip() {
            const area = document.getElementById('capture-area');
            const canvas = await html2canvas(area, { scale: 2 });
            canvas.toBlob(blob => {
                const file = new File([blob], 'slip.png', { type: 'image/png' });
                if (navigator.share) navigator.share({ files: [file], title: 'Pay Slip' });
                else {
                    const link = document.createElement('a'); link.download = 'slip.png';
                    link.href = canvas.toDataURL(); link.click();
                }
            });
        }
        init();
    </script>
</body>
          </html>
